@page "/analytics"
@using MauiApp1.Models
@inject MauiApp1.Data.JournalDb Db
@inject IJSRuntime JS


<div class="dashboard-root light">
    <div class="dashboard-top">
        <div>
            <h1 class="greeting">Analytics ğŸ“Š</h1>
            <p class="date">Insights from your journal</p>
        </div>

        <button class="theme-btn" @onclick="GoBack">
            â†
        </button>
    </div>
    <!-- DATE RANGE FILTER -->
    <div class="analytics-filter">
        <input type="date"
               value="@FromDateStr"
               @onchange="e => FromDateStr = e.Value?.ToString()" />

        <input type="date"
               value="@ToDateStr"
               @onchange="e => ToDateStr = e.Value?.ToString()" />

        <button class="gradient-pill-btn" @onclick="ApplyFilter">
            Apply
        </button>
    </div>

    <!-- SUMMARY STATS -->
    <div class="stats-grid">

        <div class="stat-card">
            <p class="stat-label">Most Frequent Mood</p>
            <h2>@MostFrequentMood</h2>
        </div>

        <div class="stat-card">
            <p class="stat-label">Current Streak</p>
            <h2>ğŸ”¥ @CurrentStreak Days</h2>
        </div>

        <div class="stat-card">
            <p class="stat-label">Longest Streak</p>
            <h2>ğŸ† @LongestStreak Days</h2>
        </div>

        <div class="stat-card">
            <p class="stat-label">Missed Days</p>
            <h2>âŒ @MissedDays</h2>
        </div>

    </div>

    <!-- MOOD DISTRIBUTION -->
    <div class="analytics-card">
        <h3>Mood Distribution</h3>
        <div class="analytics-card">
    <h3>Mood Distribution</h3>

    <div class="mood-pie-wrapper">

        <div class="mood-pie"
             style="
                --positive:@PositivePct%;
                --neutral:@NeutralPct%;
                --negative:@NegativePct%;
             ">
        </div>

        <div class="mood-legend">
            <span>
                <span class="legend-dot dot-positive"></span>
                ğŸ˜Š Positive â€” @PositivePct%
            </span>

            <span>
                <span class="legend-dot dot-neutral"></span>
                ğŸ˜ Neutral â€” @NeutralPct%
            </span>

            <span>
                <span class="legend-dot dot-negative"></span>
                ğŸ˜” Negative â€” @NegativePct%
            </span>
        </div>

    </div>
</div>

    </div>

    <!-- TAG ANALYTICS -->
    <div class="analytics-card">
        <h3>Most Used Tags</h3>

        @if (TopTags.Any())
        {
            <ul>
                @foreach (var tag in TopTags)
                {
                    <li>@tag.Key (@tag.Value)</li>
                }
            </ul>
        }
        else
        {
            <p>No tags recorded.</p>
        }
    </div>

    <!-- WORD COUNT -->
    <div class="analytics-card">
        <h3>Average Word Count</h3>
        <p>@AverageWordCount words per entry</p>
    </div>

</div>

@code {
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }


    private string FromDateStr = DateTime.Today.AddMonths(-1).ToString("yyyy-MM-dd");
    private string ToDateStr = DateTime.Today.ToString("yyyy-MM-dd");

    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDays;

    private string MostFrequentMood = "â€”";

    private int PositivePct;
    private int NeutralPct;
    private int NegativePct;

    private Dictionary<string, int> TopTags = new();
    private int AverageWordCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }

    // ğŸ”¹ APPLY BUTTON HANDLER
    private async Task ApplyFilter()
    {
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        if (!DateTime.TryParse(FromDateStr, out var from) ||
            !DateTime.TryParse(ToDateStr, out var to))
            return;

        var entries = await Db.GetEntriesByDateRangeAsync(from, to);

        // STREAKS
        var streak = await Db.GetStreakStatsAsync();
        CurrentStreak = streak.current;
        LongestStreak = streak.longest;
        MissedDays = streak.missed;

        // MOOD ANALYSIS
        var moodCounts = entries
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .ToDictionary(g => g.Key, g => g.Count());

        if (moodCounts.Any())
            MostFrequentMood = moodCounts
                .OrderByDescending(x => x.Value)
                .First().Key;
        else
            MostFrequentMood = "â€”";

        int positive = moodCounts.Where(m => IsPositive(m.Key)).Sum(m => m.Value);
        int neutral = moodCounts.Where(m => IsNeutral(m.Key)).Sum(m => m.Value);
        int negative = moodCounts.Where(m => IsNegative(m.Key)).Sum(m => m.Value);

        int total = Math.Max(1, entries.Count);

        PositivePct = positive * 100 / total;
        NeutralPct = neutral * 100 / total;
        NegativePct = negative * 100 / total;

        // TAGS
        TopTags = entries
            .Where(e => !string.IsNullOrWhiteSpace(e.TagsCsv))
            .SelectMany(e => e.TagsCsv.Split(',', StringSplitOptions.RemoveEmptyEntries))
            .Select(t => t.Trim())
            .GroupBy(t => t)
            .OrderByDescending(g => g.Count())
            .Take(5)
            .ToDictionary(g => g.Key, g => g.Count());

        // WORD COUNT
        AverageWordCount = entries.Any()
            ? (int)Math.Round(
                entries.Average(e =>
                    StripHtml(e.ContentHtml)
                        .Split(' ', StringSplitOptions.RemoveEmptyEntries)
                        .Length))
            : 0;
    }

    private bool IsPositive(string mood) =>
        new[] { "Happy", "Excited", "Grateful", "Relaxed", "Confident" }.Contains(mood);

    private bool IsNeutral(string mood) =>
        new[] { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" }.Contains(mood);

    private bool IsNegative(string mood) =>
        new[] { "Sad", "Angry", "Stressed", "Lonely", "Anxious" }.Contains(mood);

    private static string StripHtml(string html) =>
        System.Text.RegularExpressions.Regex.Replace(html ?? "", "<.*?>", "");
}
